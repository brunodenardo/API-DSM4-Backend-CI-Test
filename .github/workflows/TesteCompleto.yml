
name: Teste Completo

on: 
  pull_request: 
    branches:
      - release


jobs:
    TesteUnitario:
        runs-on: ubuntu-latest

        container:
          image: pedrohsalmeida/nimbus-backend:latest
          options: --entrypoint /bin/sh # Usa '/bin/sh' para garantir que os comandos 'run' funcionem
          env:
            PORT: ${{ secrets.PORT }}
            JWT_SECRET: ${{ secrets.JWT_SECRET }}
            DB_URL_MONGO_BACK: ${{ secrets.DB_URL_MONGO_BACK }}



        steps:
        - name: Checkout code
          uses: actions/checkout@v3

        - name: Instalando dempendencias
          run: npm install


        - name: rodando testes
          id: test
          run: npm run test:unit


    TesteIntegracao:
      needs: TesteUnitario
      runs-on: ubuntu-latest

      steps:

        - name: Checkout code
          uses: actions/checkout@v3

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Build backend container image
          run: |
            docker build -t backend/testeintegracao .

        - name: Run PostgreSQL
          run: |
            docker pull postgres
            docker run --name db -e POSTGRES_USER=${{ secrets.POSTGRES_USER }} -e POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} -e POSTGRES_DB=${{ secrets.DB_NAME_TEST }} -d postgres

        - name: Rodar back
          run: |
            docker run --name backend --link db:db -e PORT=${{ secrets.PORT }} -e JWT_SECRET=dsishnidni -e DB_HOST=db -e DB_USER=${{ secrets.DB_USER }} -e DB_PORT=${{ secrets.DB_PORT }} -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} -e DB_NAME_TEST=${{ secrets.DB_NAME_TEST }} -d --link db:db backend/testeintegracao sh -c "npm run migration:run && npm run test:cypress"
            docker logs backend
            docker inspect backend

          # -e JWT_SECRET=${{ secrets.JWT_SECRET }} -e DB_NAME=${{ secrets.DB_NAME }} -e DB_HOST=db -e DB_USER=${{ secrets.DB_USER }} -e DB_PORT=${{ secrets.DB_PORT }} -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} -e DB_NAME_TEST=${{ secrets.DB_NAME_TEST }}

        - name: Rodar frontend
          run: |
            docker pull pedrohsalmeida/nimbus-frontend:Dev-latest
            docker run --name frontend -d pedrohsalmeida/nimbus-frontend:Dev-latest sh -c "npm build && npm start"
            docker exec frontend apk add --no-cache libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2 libxtst6 xauth xvfb

        - name: Rodar os testes do frontend
          run: |
            docker ps
            docker exec frontend apk add --no-cache libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2 libxtst6 xauth xvfb
            docker exec frontend ls -la
            docker exec frontend npx cypress run

    
    AceitaRecusaPR:
      runs-on: ubuntu-latest
      needs: TesteIntegracao
      steps:
        - name: Checkout code
          uses: actions/checkout@v3


        - name: Aprovando pull_request se os testes passarem
          uses: juliangruber/approve-pull-request-action@v2 
          with:
              github-token: ${{ secrets.ADM_TOKEN }}
              number: ${{ github.event.pull_request.number }}


        - name: Merge Pull Request
          uses: juliangruber/merge-pull-request-action@v1
          with:
            github-token: ${{ secrets.ADM_TOKEN }}
            number: ${{ github.event.pull_request.number }}
            method: squash


        - run: echo "HEAD:${{github.event.pull_request.head.repo.name}}, BASE:${{github.event.pull_request.base.repo.name}}"


    PushDokerHub:
      runs-on: ubuntu-latest


      needs: AceitaRecusaPR


      steps:
        - name: Checkout code
          uses: actions/checkout@v3


        - name: Instalar Docker Compose
          run: sudo apt-get install docker-compose


        - name: Construir Imagem Docker
          run: docker-compose build




        - name: Configurar Docker para autenticação
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_TOKEN }}


        - name: Construir a imagem Docker
          run: |
            # Usando o número do pull request como parte da tag
            docker build -t pedrohsalmeida/nimbus-backend:Rel-0.${{ github.event.number }}
            docker tag pedrohsalmeida/nimbus-backend:Rel-0.${{ github.event.number }} pedrohsalmeida/nimbus-backend:Rel-latest
            docker build -t pedrohsalmeida/nimbus-backend:Rel-0.${{ github.event.number }}
            docker tag pedrohsalmeida/nimbus-backend:Rel-0.${{ github.event.number }} pedrohsalmeida/nimbus-backend:Rel-latest
    
        - name: Push da imagem para o Docker Hub
          run: |
            docker push pedrohsalmeida/nimbus-backend:Rel-0.${{ github.event.number }}
            docker push pedrohsalmeida/nimbus-backend:Rel-latest

            docker push pedrohsalmeida/nimbus-backend:Rel-0.${{ github.event.number }}
            docker push pedrohsalmeida/nimbus-backend:Rel-latest
